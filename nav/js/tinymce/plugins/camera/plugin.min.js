tinymce.PluginManager.add("camera", function(editor, url) {
    // Add a button that opens a window
    editor.addButton("camera", {
        text: "Photo",
        icon: "img/camera.png",
        onclick: function() {
			var streaming = false;
			// chercher la div webcam (dialog box) et la créer si elle n'existe pas
			var w = $("#webcam");
			if(w.length == 0) {
				var b = $("body");
				var	html = '<div id="webcam" style="display:none"><video id="video" width="600px" height="400px"></video>';
				html += '<canvas id="canvas" style="display:none;"></canvas><br>';
				html += '<button id="startbutton">OK</button> <button id="annulerbutton">Annuler</button></div>';
				b.append(html);
			}
			// initialiser les éléments
			var webcam	= document.querySelector('#webcam'),
			video		= document.querySelector('#video'),
			canvas		= document.querySelector('#canvas'),
			startbutton	= document.querySelector('#startbutton'),
			annulerbutton = document.querySelector('#annulerbutton'),
			width 		= video.width,
			height 		= video.height,
			pasdewebcam	= false;
			
			// chercher s'il existe une webcam sur l'appreil et l'initialiser
			navigator.getMedia = ( navigator.getUserMedia ||
				navigator.webkitGetUserMedia ||
				navigator.mozGetUserMedia ||
				navigator.msGetUserMedia);

			navigator.getMedia(
				{video: true, audio: false},
				function(stream) {
					if (navigator.mozGetUserMedia) {
						video.mozSrcObject = stream;
					} else {
						var vendorURL = window.URL || window.webkitURL;
						video.src = vendorURL.createObjectURL(stream);
					}
					video.play();
				},
				function(err) {
					pasdewebcam = true;
				}
			);
			if(pasdewebcam) {
				alert("Il n'y a pas d'appareil photo !");
				$('#webcam').remove(); // pas de webcam : enlever la dialogbox
			} else {
				// ajout de l'événement canplay à la video
				video.addEventListener(
					'canplay', 
					function(ev){
						if (!streaming) {
							height = video.videoHeight / (video.videoWidth/width);
							video.setAttribute('width', width);
							video.setAttribute('height', height);
							canvas.setAttribute('width', width);
							canvas.setAttribute('height', height);
							streaming = true;
						}
					}, 
					false);	
					
				// fonction de récupération de la photo				
				function takepicture(f) {
					canvas.width = canvas.width;
					canvas.height = canvas.height;
					canvas.getContext('2d').drawImage(video, 0, 0, width, height);
					var data = canvas.toDataURL(f);
					return data;
				}
				
				function fermerwebcam() {
					video.pause();
					w.dialog("destroy");
					w.remove();
				}

				// ajout de l'événemnt click du bouton OK
				startbutton.addEventListener(
					'click',
					function (ev) {
						var photo = takepicture('image/png');
						if (photo.length > 6) {
							editor.insertContent('<img src="' + photo + '"></img>');
						}
						fermerwebcam();
					}, 
					false);	
					
				// ajout de l'événemnt click du bouton ANNULER	
				annulerbutton.addEventListener(
					'click',
					function (ev) {fermerwebcam()},
					false);	

				// trouver la webcam et l'activer dans la boite de dialogue
				video.play();
				var w = $('#webcam');
				w.css("display","block");
				w.dialog({autoOpen: false});
				w.dialog("option", "resizable", true );
				w.dialog("option", 'height', "auto");
				w.dialog("option", 'width', "auto");
				w.dialog("open");
			} // pas d'erreur
		}
    });
});
